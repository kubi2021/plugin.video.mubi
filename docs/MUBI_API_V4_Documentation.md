# MUBI API v4 Technical Documentation

*This documentation was generated by AI based on analysis of the MUBI Kodi addon source code.*

## Overview

This document describes the MUBI API v4 endpoints used in the Kodi addon for streaming content from MUBI. The API base URL is `https://api.mubi.com/v4/`.

## Authentication

The API uses Bearer token authentication. Tokens are obtained through the device linking process.

### Headers

**Standard Web Headers (`hea_gen()` / `heaGen()`)**:
- `Authorization`: Bearer token
- `Client`: web
- `Client-Country`: User's country code
- `Client-Accept-Audio-Codecs`: eac3,aac
- `Client-Accept-Video-Codecs`: h265,vp9,h264
- `User-Agent`: Browser user agent (Mozilla/Firefox)
- `accept-language`: User's language preference
- `Referer`: https://mubi.com
- `Origin`: https://mubi.com
- `Anonymous_user_id`: Device ID

**Android TV Headers (`hea_atv_auth()` / `heaATVGen()`)**:
- `client`: android_tv
- `client-version`: 36.1
- `client-device-identifier`: Device ID
- `client-country`: User's country code
- `User-Agent`: okhttp/4.10.1
- `Authorization`: Bearer token (when authenticated)

## Header Usage Guidelines

**Use Web Headers for**:
- `/browse/films` - **Critical**: Web headers return full catalog (568 films vs 45 with Android TV headers)
- `/browse/film_groups` - Collections browsing
- Most browsing endpoints

**Use Android TV Headers for**:
- `/film_groups/{id}/film_group_items` - Category-specific film listings
- `/authenticate` and `/link_code` - Authentication flows
- Playback-related endpoints

## Authentication Endpoints

### Get Link Code
**Endpoint**: `GET /link_code`  
**Headers**: Android TV headers  
**Parameters**: None  
**Returns**: 
```json
{
  "auth_token": "string",
  "link_code": "string"
}
```

### Authenticate Device
**Endpoint**: `POST /authenticate`  
**Headers**: Android TV headers  
**Body**: 
```json
{
  "auth_token": "string"
}
```
**Returns**:
```json
{
  "token": "string",
  "user": {
    "id": "integer"
  }
}
```

### Logout
**Endpoint**: `DELETE /sessions`  
**Headers**: Android TV headers + Authorization  
**Returns**: HTTP 200 on success

## Content Discovery

### Important Discovery: Sort Parameter Requirement

**Critical Finding**: The `/browse/films` endpoint behavior varies significantly based on parameters:

| Parameters | Result | Use Case |
|------------|--------|----------|
| No parameters | ~124 films total | Basic catalog browsing |
| `playable=true` only | ~45 films | Limited playable set |
| `playable=true` + `sort=popularity` | **~568 films** | **Full playable catalog** |
| `sort=popularity` only | ~568 films | Full catalog (all films) |

**Key Insights**:
- **Always include a `sort` parameter** when fetching films to get the complete catalog
- Without `sort`, the API returns only a limited default subset
- All sort options (`popularity`, `release_date`, `title`, `rating`) return the same total count
- This explains why category-based sync was getting 400+ films while direct API was getting only 45

### Enhanced Metadata Implementation

**Plot Description Enhancement**:
The addon now uses enhanced editorial content for richer film descriptions:

```python
# Enhanced plot logic
default_editorial = film_info.get('default_editorial', '')
short_synopsis = film_info.get('short_synopsis', '')

if default_editorial:
    plot = default_editorial  # Rich editorial content
else:
    plot = short_synopsis     # Fallback to basic synopsis

plotoutline = short_synopsis  # Always use synopsis for outline
```

**Benefits**:
- **Richer descriptions**: Editorial content provides professional film analysis
- **Better user experience**: More detailed plot information in Kodi
- **Graceful fallback**: Uses synopsis when editorial content unavailable
- **Dual content**: Plot gets editorial, outline gets synopsis for different UI contexts

**Example Comparison**:
- **Synopsis**: "A handbag sits alone on a rock in Tuscany."
- **Editorial**: "Returning to the whimsical love for fashion that shone in Caprice, Joanna Hogg finds an improbable protagonist in a designer handbag in this short film. Complemented by lavishly tactile, immersive imagery, the luxury item speaks with wry humor not only to the fickleness of trends, but fate itself."

### Browse Films
**Endpoint**: `GET /browse/films`
**Headers**: Standard web headers (see header section below)
**Parameters**:
- `sort`: **REQUIRED** - Sorting method (e.g., "popularity", "release_date", "title", "rating")
- `playable`: "true" to show only playable content
- `page`: Page number for pagination
- `per_page`: Items per page (optional, defaults to API default)
- Additional filter parameters

**Important Notes**:
- **The `sort` parameter is crucial** - without it, the API returns only a limited subset (~45 films)
- **With `sort` parameter**: Returns the full catalog (~568 playable films when `playable=true`)
- **Recommended sort options**: "popularity", "release_date", "title", "rating" all return the same total count
- **Use web headers** (`hea_gen()`) rather than Android TV headers for best results

**Returns**:
```json
{
  "films": [
    {
      "id": "integer",
      "slug": "string",
      "title": "string",
      "title_locale": "string",
      "original_title": "string",
      "year": "integer",
      "duration": "integer (minutes)",
      "stills": {
        "small": "string (URL)",
        "medium": "string (URL)",
        "standard": "string (URL)",
        "retina": "string (URL)",
        "small_overlaid": "string (URL)",
        "large_overlaid": "string (URL)",
        "standard_push": "string (URL)"
      },
      "still_focal_point": {
        "x": "float",
        "y": "float"
      },
      "hd": "boolean",
      "average_colour_hex": "string",
      "trailer_url": "string (URL)",
      "trailer_id": "integer",
      "popularity": "integer",
      "web_url": "string (URL)",
      "genres": ["string"],
      "average_rating": "float (out of 5)",
      "average_rating_out_of_ten": "float (out of 10)",
      "number_of_ratings": "integer",
      "mubi_release": "boolean",
      "should_use_safe_still": "boolean",
      "still_url": "string (URL)",
      "title_upcase": "string",
      "critic_review_rating": "float",
      "content_rating": {
        "label": "string",
        "rating_code": "string",
        "description": "string",
        "icon_url": "string|null",
        "label_hex_color": "string"
      },
      "episode": "object|null",
      "short_synopsis": "string",
      "short_synopsis_html": "string",
      "historic_countries": ["string"],
      "portrait_image": "string|null",
      "title_treatment_url": "string|null",
      "experiment_stills": "object|null",
      "experiment_stills_multi": "object|null",
      "default_editorial": "string",
      "default_editorial_html": "string",
      "cast_members_count": "integer",
      "industry_events_count": "integer",
      "comments_count": "integer",
      "mubi_go_highlighted": "boolean",
      "optimised_trailers": [
        {
          "url": "string (URL)",
          "profile": "string (240p|720p|1080p)"
        }
      ],
      "directors": [
        {
          "name": "string",
          "name_upcase": "string",
          "slug": "string"
        }
      ],
      "consumable": {
        "film_id": "integer",
        "available_at": "string (ISO datetime)",
        "availability": "string (live|upcoming|expired)",
        "availability_ends_at": "string (ISO datetime)",
        "expires_at": "string (ISO datetime)",
        "film_date_message": "string|null",
        "offered": [
          {
            "type": "string (catalogue|rental)",
            "download_availability": "object|null"
          }
        ],
        "exclusive": "boolean",
        "permit_download": "boolean",
        "playback_languages": {
          "audio_options": ["string"],
          "subtitle_options": ["string"],
          "media_options": {
            "duration": "integer (seconds)",
            "hd": "boolean"
          },
          "media_features": ["string (4K|stereo|5.1|etc)"],
          "extended_audio_options": ["string"]
        }
      },
      "press_quote": "string|null",
      "star_rating": "object|null",
      "award": "object|null",
      "series": "object|null",
      "content_warnings": ["string"],
      "artworks": [
        {
          "format": "string",
          "locale": "string|null",
          "image_url": "string (URL)",
          "focal_point": {
            "x": "float",
            "y": "float"
          }
        }
      ],
      "highlighted_industry_event_entry": "object|null"
    }
  ],
  "meta": {
    "current_page": "integer",
    "next_page": "integer|null",
    "previous_page": "integer|null",
    "total_pages": "integer",
    "total_count": "integer",
    "per_page": "integer"
  }
}
```

**Example Usage**:
```bash
GET /v4/browse/films?sort=title&playable=true&page=1
```

### Key Film Object Fields

**Essential Metadata**:
- `id`: Unique film identifier
- `title`: Display title
- `original_title`: Original language title
- `year`: Release year
- `duration`: Runtime in minutes
- `short_synopsis`: Basic plot description
- `default_editorial`: **Enhanced editorial content** (richer than synopsis)
- `genres`: Array of genre strings
- `historic_countries`: Production countries
- `directors`: Array of director objects with name and slug

**Ratings & Popularity**:
- `average_rating`: User rating out of 5
- `average_rating_out_of_ten`: User rating out of 10
- `number_of_ratings`: Total user ratings count
- `critic_review_rating`: Professional critic rating
- `popularity`: Popularity ranking number

**Media Assets**:
- `stills`: Multiple image sizes and formats
- `still_url`: Primary still image URL
- `trailer_url`: Main trailer URL
- `optimised_trailers`: Multiple trailer quality options
- `artworks`: Various artwork formats for different UI contexts

**Availability**:
- `consumable`: Complete availability and playback information
  - `available_at`: When film becomes available
  - `expires_at`: When film expires
  - `availability`: Current status (live/upcoming/expired)
  - `playback_languages`: Audio/subtitle options and media features
  - `permit_download`: Download availability

**Content Information**:
- `content_rating`: Age rating and content warnings
- `content_warnings`: Array of specific content warnings
- `hd`: HD availability flag
- `mubi_release`: Whether it's a MUBI original/exclusive

### Browse Collections
**Endpoint**: `GET /browse/film_groups`  
**Headers**: Standard web headers  
**Parameters**:
- `sort`: Sorting method
- `page`: Page number

**Returns**:
```json
{
  "film_groups": [
    {
      "id": "integer",
      "title": "string",
      "full_title": "string",
      "description": "string",
      "image": "string"
    }
  ],
  "meta": {
    "next_page": "integer|null"
  }
}
```

### Browse Cast & Crew
**Endpoint**: `GET /browse/cast_members`  
**Headers**: Standard web headers  
**Parameters**:
- `page`: Page number
- Additional filter parameters

**Returns**:
```json
{
  "cast_members": [
    {
      "id": "integer",
      "name": "string",
      "slug": "string",
      "primary_type": "string",
      "image_url": "string"
    }
  ],
  "meta": {
    "next_page": "integer|null"
  }
}
```

### Browse Lists
**Endpoint**: `GET /browse/lists`  
**Headers**: Standard web headers  
**Parameters**:
- `sort`: Sorting method
- `page`: Page number

**Returns**:
```json
{
  "lists": [
    {
      "title": "string",
      "slug": "string",
      "description": "string",
      "fan_count": "integer",
      "film_count": "integer",
      "thumbnails": [
        {
          "src": "string"
        }
      ]
    }
  ],
  "meta": {
    "next_page": "integer|null"
  }
}
```

### Browse Industry Events
**Endpoint**: `GET /browse/industry_events`  
**Headers**: Standard web headers  
**Parameters**:
- `sort`: Sorting method
- `page`: Page number
- Additional filter parameters

**Returns**:
```json
{
  "industry_events": [
    {
      "id": "integer",
      "name": "string",
      "slug": "string",
      "white_logo_url": "string"
    }
  ],
  "meta": {
    "next_page": "integer|null"
  }
}
```

## Content Details

### Collection Items
**Endpoint**: `GET /film_groups/{id}/film_group_items`  
**Headers**: Standard web headers  
**Parameters**:
- `include_upcoming`: "true"
- `page`: Page number
- `per_page`: Items per page (24)

**Returns**:
```json
{
  "film_group_items": [
    {
      "film": {
        "id": "integer",
        "title": "string"
      }
    }
  ],
  "meta": {
    "next_page": "integer|null"
  }
}
```

### Cast Member Details
**Endpoint**: `GET /cast_members/{slug}`  
**Headers**: Standard web headers  
**Returns**:
```json
{
  "name": "string",
  "image_url": "string",
  "credits": [
    {
      "credit": "string",
      "type": "string"
    }
  ]
}
```

### Cast Member Films
**Endpoint**: `GET /cast_members/{id}/films`  
**Headers**: Standard web headers  
**Parameters**:
- `page`: Page number
- `per_page`: Items per page (12)
- `cast_member_credit`: Credit type

### List Films
**Endpoint**: `GET /lists/{slug}/list_films`  
**Headers**: Standard web headers  
**Parameters**:
- `page`: Page number
- `per_page`: Items per page (48)

**Returns**:
```json
{
  "list_films": [
    {
      "film": {
        "id": "integer",
        "title": "string"
      }
    }
  ],
  "meta": {
    "next_page": "integer|null"
  }
}
```

### Industry Event Years
**Endpoint**: `GET /industry_events/{slug}/years`  
**Headers**: Standard web headers  
**Returns**: Array of year integers

### Industry Event Films
**Endpoint**: `GET /industry_events/{id}/films`  
**Headers**: Standard web headers  
**Parameters**:
- `year`: Filter by year
- `status`: Filter by status
- `page`: Page number

**Returns**:
```json
{
  "films": [
    {
      "id": "integer",
      "title": "string"
    }
  ],
  "meta": {
    "next_page": "integer|null"
  }
}
```

## Series Support

### Series Seasons
**Endpoint**: `GET /series/{id}/up_next`  
**Headers**: Standard web headers  
**Returns**:
```json
{
  "series": {
    "seasons": [
      {
        "title": "string",
        "slug": "string"
      }
    ]
  }
}
```

### Season Episodes
**Endpoint**: `GET /series/{id}/seasons/{season_slug}/episodes`  
**Headers**: Standard web headers  
**Parameters**:
- `page`: Page number

**Returns**:
```json
{
  "episodes": [
    {
      "id": "integer",
      "title": "string"
    }
  ],
  "meta": {
    "next_page": "integer|null"
  }
}
```

## Search

### Search Films
**Endpoint**: `GET /search/films`  
**Headers**: Standard web headers  
**Parameters**:
- `query`: URL-encoded search term
- `page`: Page number
- `per_page`: Items per page (24)
- `playable`: "true" (optional)

### Search Cast Members
**Endpoint**: `GET /search/cast_members`  
**Headers**: Standard web headers  
**Parameters**: Same as search films

## Playback

### Create Viewing Session
**Endpoint**: `POST /films/{id}/viewing`  
**Headers**: Standard web headers  
**Parameters**: `parental_lock_enabled=true`  
**Body**: `{}`

### Get Secure Stream URL
**Endpoint**: `GET /films/{id}/viewing/secure_url`  
**Headers**: Standard web headers  
**Returns**:
```json
{
  "url": "string",
  "drm_license_url": "string"
}
```

### Preroll Viewing
**Endpoint**: `POST /prerolls/viewings`  
**Headers**: Standard web headers  
**Body**:
```json
{
  "viewing_film_id": "integer"
}
```

### Film Language Options
**Endpoint**: `GET /films/{id}/playback_languages`  
**Headers**: Standard web headers  
**Returns**:
```json
{
  "audio_options": ["string"],
  "subtitle_options": ["string"],
  "media_features": ["string"]
}
```

## DRM Configuration

For protected content, the addon uses Widevine DRM with the following license server:
- **License URL**: `https://lic.drmtoday.com/license-proxy-widevine/cenc/`
- **Custom Data**: Base64 encoded JSON with userId, sessionId, and merchant

## Error Handling

API errors typically return:
```json
{
  "message": "string",
  "user_message": "string"
}
```

Common HTTP status codes:
- 200: Success
- 401: Unauthorized (invalid token)
- 404: Not found
- 500: Server error