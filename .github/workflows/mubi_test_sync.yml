name: Mubi Deep Sync Test (Single Country)

on:
  workflow_dispatch:
    inputs:
      country:
        description: 'Country code to test (e.g., DE, US, GB)'
        required: true
        default: 'DE'
        type: string

permissions:
  contents: read

jobs:
  test-sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11' 

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi

    - name: Run Scraper (Single Country - ${{ inputs.country }})
      continue-on-error: true  # Single-country test won't meet MIN_TOTAL_FILMS threshold
      run: |
        # Create output directory
        mkdir -p database/v1
        
        # Run scraper for single country only
        # Run scraper for single country only
        python backend/scraper.py --mode deep --countries ${{ inputs.country }} --output database/v1/films.json --series-output database/v1/series.json

        # Download previous database for Bayesian Warm Start (Optional for test, but good for coverage)
        wget https://raw.githubusercontent.com/kubi2021/plugin.video.mubi/database/v1/films.json.gz -O backend/previous_films.json.gz || echo "No previous database found."
        if [ -f backend/previous_films.json.gz ]; then
          gzip -d backend/previous_films.json.gz
        fi
        
    - name: Enrich Metadata (Add IMDB/TMDB IDs)
      if: always()
      continue-on-error: true  # May fail if scraper produced no output
      env:
        TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
        OMDB_API_KEYS: ${{ secrets.OMDB_API_KEYS }}
      run: |
        python backend/enrich_metadata.py --path database/v1/films.json
        python backend/enrich_metadata.py --path database/v1/series.json --type series

    - name: Calculate Bayesian Ratings
      if: always()
      continue-on-error: true
      run: |
        echo "Running Bayesian Rating Calculator..."
        if [ -f database/v1/films.json ]; then 
            if [ -f backend/previous_films.json ]; then
                python backend/rating_calculator.py database/v1/films.json --history-file backend/previous_films.json
            else
                python backend/rating_calculator.py database/v1/films.json
            fi
        fi
        if [ -f database/v1/series.json ]; then python backend/rating_calculator.py database/v1/series.json; fi
        
    - name: Generate Repo Files (Compress & Hash)
      if: always()
      continue-on-error: true
      run: |
        cd database/v1
        python ../../backend/generate_repo.py --file films.json
        python ../../backend/generate_repo.py --file series.json
        
        # Verify output
        ls -la

    - name: Validate Schema (Optional)
      if: always()
      continue-on-error: true  # Schema validation is informational for test runs
      run: |
        pip install jsonschema
        python backend/validate_schema.py --path database/v1/films.json --version 1
        python backend/validate_schema.py --path database/v1/series.json --version 1
        
    - name: Show Results Summary
      if: always()
      run: |
        echo "=== Test Sync Summary ==="
        echo "Country: ${{ inputs.country }}"
        if [ -f database/v1/films.json ]; then
          echo "Films count: $(python -c "import json; print(json.load(open('database/v1/films.json'))['meta']['total_count'])")"
        else
          echo "Films: NO OUTPUT"
        fi
        if [ -f database/v1/series.json ]; then
          echo "Series count: $(python -c "import json; print(json.load(open('database/v1/series.json'))['meta']['total_count'])")"
        else
          echo "Series: NO OUTPUT"
        fi
        echo "========================="

    # NOTE: No deploy step - this is for testing only
